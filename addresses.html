<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Address</title>
    <!-- Add Bootstrap CSS link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Add your custom CSS styles here -->
    <style>
        /* Custom CSS styles for the user profile page */
        body {
            min-height: 100vh;
            background-image: linear-gradient(to top, #96fbc4 0%, #f9f586 100%);
            /* position: relative; */
        }

        .container {
            background-color: #ffffff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            width: 50%;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #shown-cart {
            top: -5px;
            left: 15px;
        }

        /* Additional styles for navbar */
        .navbar {
            /* background: #fff; */
            background: linear-gradient(0deg, rgba(34, 193, 195, 1) 0%, rgba(45, 175, 253, 1) 100%);
            /* border-bottom: 1px solid #ccc; */
        }

        .navbar-brand.custom-brand {
            color: #007bff;
            font-size: 2rem;
        }

        .nav-link.custom-brand {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: bold;
            margin-right: 20px;
        }

        /* Styles for centering the modal */
        .modal-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .hidden {
            display: none;
        }

        .overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(81, 79, 79, 0.5);
            backdrop-filter: blur(3px);
            z-index: 5;
        }

        .gradient-custom {
            /* fallback for old browsers */
            background: #f6d365;

            /* Chrome 10-25, Safari 5.1-6 */
            background: -webkit-linear-gradient(to right bottom,
                    rgba(246, 211, 101, 1),
                    rgba(253, 160, 133, 1));

            /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
            background: linear-gradient(to right bottom,
                    rgba(246, 211, 101, 1),
                    rgba(253, 160, 133, 1));
        }

        /* Responsive styles for small screens */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                width: 80%;
            }

            nav ul {
                text-align: center;
            }

            nav ul li {
                display: block;
                margin-bottom: 10px;
            }
        }

        #shown-cart {
            top: -5px;
            left: 15px;
        }

        
        footer {
            background: linear-gradient(0deg, #36dadc 0%, #64bcf3 100%);
        }

        @media (min-width: 576px) {
            .nav-item {
                transition: all 0.3s linear;
            }

            .nav-item:hover {
                transform: translate(-0.5px, -3px);
                scale: 1.01;
            }

            .logo {
                transition: all 0.3s linear;
            }

            .logo:hover {
                scale: 1.1;
            }
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay">
        <div class="d-flex justify-content-center align-items-center" style="width: 100%; height: 100%">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    <div id="main" class="hidden">
        <!-- Navigation -->
        <nav class="navbar m-2 mt-2 shadow-sm rounded-3 navbar-expand-lg bg-body-tertiary pt-0" id="header">
            <div class="container-fluid">
                <a href="index.html">
                    <img src="./images/temp.png" class="navbar-brand custom-brand logo" alt="Home" width="120px"
                        title="Home"></img>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="d-flex justify-content-between w-100">
                        <div class="">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="index.html">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="products.html">Products</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="aboutus.html">About Us</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="contactus.html">Contact Us</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="adminAppbar">
                                    <a class="nav-link custom-brand active" aria-current="page">Profile</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="customerAppbar">
                                    <a class="nav-link custom-brand" href="user.html">Profile</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="customerAppbar">
                                    <a class="nav-link custom-brand active" aria-current="page">Addresses</a>
                                </li>
                                <li class="nav-item">
                                    <!-- Logout button with data-toggle and data-target attributes -->
                                    <button class="nav-link custom-brand" data-bs-toggle="modal"
                                        data-bs-target="#logoutConfirmationModal">
                                        Logout
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <ul class="navbar-nav mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <a class="nav-link custom-brand position-relative" href="cart.html">
                                        <i class="fa-solid fa-cart-shopping me-0"></i>
                                        <span class="position-absolute badge rounded-pill bg-danger p-1 px-2"
                                            id="shown-cart"></span>
                                        <span class="ps-0 ms-0">Cart</span>
                                    </a>
                                </li>
                                <li class="nav-item loggedOut">
                                    <a class="nav-link custom-brand" href="signup.html">Sign Up</a>
                                </li>
                                <li class="nav-item loggedOut">
                                    <a class="nav-link custom-brand" href="login.html">Login</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <!-- Toast notifications will appear here -->
        </div>

        <div class="container">
            <h2>Add New Address</h2>

            <!-- Add New Address Form -->
            <div id="addAddressForm" class="mt-4">
                <form id="addressForm">
                    <div class="mb-3">
                        <label for="displayName">Full Name:</label>
                        <input type="text" class="form-control border-primary" id="displayName" required>
                        <small id="nameError" class="text-danger"></small>
                    </div>
                    <div class="mb-3">
                        <label for="phone">Mobile Number:</label>
                        <input type="tel" class="form-control border-primary" id="phone" required>
                        <small id="phoneError" class="text-danger"></small>
                    </div>
                    <div class="mb-3">
                        <label for="houseBuilding">House No./Building Name:</label>
                        <input type="text" class="form-control border-primary" id="houseBuilding" required>
                    </div>
                    <div class="mb-3">
                        <label for="roadAreaColony">Road Name/Area/Colony:</label>
                        <input type="text" class="form-control border-primary" id="roadAreaColony" required>
                    </div>
                    <div class="mb-3">
                        <label for="pinCode">Pin Code:</label>
                        <input type="text" class="form-control border-primary" id="pinCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="city">City:</label>
                        <input type="text" class="form-control border-primary" id="city" required>
                    </div>
                    <div class="mb-3">
                        <label for="state">State:</label>
                        <input type="text" class="form-control border-primary" id="state" required>
                    </div>
                    <div class="mb-3">
                        <label for="addressType">Address Type:</label>
                        <select class="form-select border-primary" id="addressType" required>
                            <option value="home">Home</option>
                            <option value="work">Work</option>
                        </select>
                    </div>
                    <!-- <div class="mb-3">
                        <label for="address">Address:</label>
                        <textarea class="form-control" id="address" rows="3" required></textarea>
                    </div> -->
                    <div class="d-flex justify-content-around">
                        <div>
                            <button type="submit" id="addAddressBtn" class="btn btn-primary">Add New Address</button>
                        </div>
                        <div>
                            <a href="saved_addresses.html" class="btn btn-primary" role="button">Show Saved
                                Addresses</a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Logout Confirmation Modal -->
            <div class="modal fade" id="logoutConfirmationModal" tabindex="-1"
                aria-labelledby="logoutConfirmationModalLabel" data-bs-backdrop="static" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="logoutConfirmationModalLabel">
                                Confirm Logout
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">Are you sure you want to logout?</div>
                        <div class="modal-footer">
                            <!-- Cancel button to close the modal -->
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <!-- Logout button to trigger the logout -->
                            <button type="button" class="btn btn-primary" id="confirmLogoutBtn">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive"
                aria-atomic="true" id="toast-bg">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center rounded-3 py-3 m-2">
            &copy; <strong>2023 Saree Sutra. All Rights Reserved.</strong>
        </footer>
    </div>

        <!-- Add Bootstrap JS and Popper.js scripts (optional) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>

        <script type="module">
            //------------------------Firebase Config-----------------------
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
            import { ref, uploadBytes, getDownloadURL, getStorage } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-storage.js";
            import {
                getFirestore,
                collection,
                query,
                where,
                getDocs,
                doc,
                getDoc,
                setDoc,
                addDoc,
                updateDoc
            } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";
            import {
                getAuth,
                signOut,
                onAuthStateChanged,
                updatePassword,
                EmailAuthProvider,
                reauthenticateWithCredential,
            } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";

            const firebaseConfig = {
            apiKey: "AIzaSyACIWl3rw02345O2RiDnqn7j9GgHFTxruw",
            authDomain: "mysarreapp.firebaseapp.com",
            projectId: "mysarreapp",
            storageBucket: "mysarreapp.appspot.com",
            messagingSenderId: "2980423532",
            appId: "1:2980423532:web:55481de5d7f31aaca37549"
        };

            //global
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);
            const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");
            var userData = null;
            var loggedIn = null;

            // Function to check if the user is logged in
            function isUserLoggedIn() {
                return !!auth.currentUser;
            }

            //***********************************event listener**************************************
            // Add an event listener to the confirmation logout button
            confirmLogoutBtn.addEventListener("click", () => {
                signOut(auth)
                    .then(() => {
                        // Redirect to the login page or perform any other actions
                        console.log("User logged out successfully");
                        window.location.href = "login.html"; // Redirect to the login page
                    })
                    .catch((error) => {
                        console.error("Error during logout:", error);
                    });
            });

            //***************************************************************************************

            //************************cart dependency************************************************
            //update cart function cart(dependency)
            async function updateCart() {
                console.log("from update cart")
                const shownCart = document.querySelector('#shown-cart')

                if (loggedIn) {
                    //get user data
                    const userDoc = await getUserSnapshot(auth.currentUser.uid)
                    const cartSnapshot = await getDocs(collection(userDoc.ref, 'cart'))

                    if (cartSnapshot.empty) {
                        shownCart.style.display = 'none'
                        return
                    }

                    if (cartSnapshot.size >= 1) {
                        // console.log(cartItems)
                        shownCart.textContent = cartSnapshot.size
                        shownCart.style.display = 'block'
                    }
                }
                else {
                    if (!sessionStorage.getItem('cart')) {
                        shownCart.style.display = 'none'
                        return
                    }
                    else {
                        var cartList = JSON.parse(sessionStorage.getItem('cart'))
                        shownCart.textContent = cartList.length
                        shownCart.style.display = 'block'
                    }
                }
            }

            //get user snapshot cart(dependency)
            function getUserSnapshot(uid) {
                const userRef = doc(firestore, 'users', uid)
                console.log('3')
                return new Promise((resolve, reject) => {
                    resolve(getDoc(userRef))
                })
            }
            //***************************************************************************************

            //*****************************loading and role access************************************
            // Use onAuthStateChanged to control access to admin dashboard
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loggedIn = true
                    onLoggedIn();
                    // User is authenticated
                    const docRef = doc(firestore, "users", user.uid);
                    const docSnap = getDoc(docRef);
                    docSnap.then((docSnapshot) => {
                        // console.log(docSnapshot)
                        if (docSnapshot.exists()) {
                            userData = docSnapshot.data();
                            // console.log(userData.role);
                            roleAccess(userData.role);
                            updateCart();
                            stopLoader();
                            // console.log(userData)
                        }
                    });
                } else {
                    // User is not authenticated, redirect to login page
                    window.location.href = "login.html";
                }
            });

            function roleAccess(role) {
                // console.log('inside role')
                const roleMap = new Map([
                    ["ADMIN", "adminAppbar"],
                    ["CUSTOMER", "customerAppbar"],
                ]);
                const appbarList = document.querySelectorAll(`#${roleMap.get(role)}`);
                appbarList.forEach((appbar) => {
                    appbar.classList.remove("d-none");
                })
            }

            //to execute upon logging in
            function onLoggedIn() {
                var navItemList = document.querySelectorAll(".loggedIn");
                navItemList.forEach((navItem) => {
                    navItem.style.display = "block";
                });

                navItemList = document.querySelectorAll(".loggedOut");
                navItemList.forEach((navItem) => {
                    navItem.style.display = "none";
                });
            }

            //to execute upon logging out
            function onLoggedOut() {
                var navItemList = document.querySelectorAll(".loggedOut");
                navItemList.forEach((navItem) => {
                    navItem.style.display = "block";
                });

                navItemList = document.querySelectorAll(".loggedIn");
                navItemList.forEach((navItem) => {
                    navItem.style.display = "none";
                });
            }

            //stop the loader show the main body
            function stopLoader() {
                document.querySelector("#overlay").classList.add("hidden");
                document.querySelector("#main").classList.remove("hidden");
            }

            //***************************************event listener************************************************

            //event for phone number validation
            document.querySelector("#phone").addEventListener("keyup", () => {
                // Validate phone number
                if (!isValidPhoneNumber(document.querySelector("#phone").value)) {
                    // Display an error message
                    document.getElementById("phoneError").textContent =
                        "*Phone number must be 10 digits.";
                    document.getElementById("phoneError").style.scale = "1"
                    // Stop the function execution if validation fails
                } else {
                    document.getElementById("phoneError").textContent = "";
                }
            });

            //event for firstName validation
            document.querySelector("#displayName").addEventListener("keyup", () => {
                if (!isValidFirstName(document.querySelector("#displayName").value.split(' ')[0])) {
                    // Display an error message
                    document.getElementById("nameError").textContent =
                        "*Name must be at least 3 characters.";
                }
                else {
                    document.getElementById("nameError").textContent = ''
                }
            });

            //********************************pin code api integration************************************

            // Function to fetch city and state based on pin code
            document.getElementById("pinCode").addEventListener("input", function () {
                const pinCode = this.value;
                if (pinCode.length == 6) {
                    fetch(`https://india-pincode-with-latitude-and-longitude.p.rapidapi.com/api/v1/pincode/${pinCode}`, {
                        method: "GET",
                        headers: {
                            'X-RapidAPI-Host': 'india-pincode-with-latitude-and-longitude.p.rapidapi.com',
                            "X-RapidAPI-Key": "0a9d852b21mshf63ae2f46afe026p106862jsn399415a4e227",
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data && data[0]) {
                                document.getElementById("city").value = data[0].district;
                                document.getElementById("state").value = data[0].state;
                            } else {
                                displayMessage('Pin code not found.', 'danger');
                                // alert("Pin code not found.");
                            }
                        })
                        .catch(error => {
                            displayMessage('Error fetching pin code data.', 'danger');
                            // alert("Error fetching pin code data.");
                            console.error(error);
                        });
                }
            });

            //*********************************************************************************************

            // Function to get the current default address
            async function getCurrentDefaultAddress() {
                const user = auth.currentUser.uid;
                const userAddressesRef = collection(firestore, 'users', user, 'addresses');
                const querySnapshot = await getDocs(query(userAddressesRef, where("isDefault", "==", true)));

                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0]; // Return the first document with isDefault=true
                } else {
                    return null; // No default address found
                }
            }


            //*********************************************************************************************      

            // Event listener for the address form submission
            document.getElementById("addressForm").addEventListener("submit", async function (event) {

                document.querySelector('#addAddressBtn').disabled = true
                document.querySelector('#addAddressBtn').textContent = 'Adding Address...'
                event.preventDefault();

                const user = auth.currentUser.uid;

                const [firstName, lastName] = document.getElementById("displayName").value.split(" ");

                // Get all the form input values
                const fullName = document.getElementById("displayName").value;
                const mobileNumber = document.getElementById("phone").value;
                const houseBuilding = document.getElementById("houseBuilding").value;
                const roadAreaColony = document.getElementById("roadAreaColony").value;
                const pinCode = document.getElementById("pinCode").value;
                const city = document.getElementById("city").value;
                const state = document.getElementById("state").value;
                const addressType = document.getElementById("addressType").value;

                try {
                    // Check if any of the required fields are empty
                    if (!fullName || !mobileNumber || !houseBuilding || !roadAreaColony || !pinCode || !city || !state || !addressType) {
                        // Display a message to the user
                        displayMessage("Please fill in all the required details.", "danger");
                        document.querySelector('#addAddressBtn').disabled = false
                        document.querySelector('#addAddressBtn').textContent = 'Add Address'
                        return; // Stop the function execution if any required field is empty
                    }

                    // Validate first name (minimum 3 characters)
                    if (!isValidFirstName(firstName) || (!isValidPhoneNumber(mobileNumber)) || (!isValidPinCode(pinCode))) {
                        console.log(!isValidFirstName(firstName))
                        console.log((!isValidPhoneNumber(mobileNumber)))
                        console.log((!isValidPinCode(pinCode)))
                        document.querySelector('#addAddressBtn').disabled = false
                        document.querySelector('#addAddressBtn').textContent = 'Add Address'
                        displayMessage('Please check your entered values!', 'danger')
                        return; // Stop the function execution if validation fails
                    }

                    // Create an object with the address data
                    const addressData = {
                        fullName,
                        mobileNumber,
                        houseBuilding,
                        roadAreaColony,
                        pinCode,
                        city,
                        state,
                        addressType,
                        isDefault: false,
                    };

                    // Reference to the user's addresses collection
                    const userAddressesRef = collection(firestore, 'users', user, 'addresses');
                    // Add the address data to Firestore

                    // Check if this is the first address being added
                    const isFirstAddress = !(await getCurrentDefaultAddress());

                    // Add the address data to Firestore
                    const newAddressRef = await addDoc(userAddressesRef, addressData);

                    if (isFirstAddress) {
                        // If this is the first address, set it as the default address
                        await updateDoc(newAddressRef, { isDefault: true });
                    }

                    // Address added successfully
                    console.log("Address added to Firestore");

                    // Display a success message to the user
                    displayMessage("Address added successfully.", "success");

                    document.querySelector('#addAddressBtn').disabled = false
                    document.querySelector('#addAddressBtn').textContent = 'Add Address'

                    // Reset the form after adding the address
                    document.getElementById("addressForm").reset();
                } catch (error) {
                    // Handle errors here
                    console.error("Error adding address to Firestore: ", error);

                    // Display an error message to the user
                    displayMessage("Error adding address. Please try again.", "danger");

                    document.querySelector('#addAddressBtn').disabled = false
                    document.querySelector('#addAddressBtn').textContent = 'Add Address'
                } finally {
                    document.querySelector('#addAddressBtn').disabled = false;
                    document.querySelector('#addAddressBtn').textContent = 'Add Address';
                }
            });

            //*********************************************************************************************

            //******************************toast message****************************************

            //display message function
            function displayMessage(message, type) {
                // Get the toast container element
                const toastContainer = document.querySelector(".toast-container");

                // Create a clone of the toast template
                const toast = document.querySelector(".toast").cloneNode(true);

                // Set the success message
                toast.querySelector(".toast-body").textContent = message;

                //set text type  success/danger
                if (type === "danger") {
                    toast.classList.remove("bg-success");
                    toast.classList.add("bg-danger");
                } else {
                    toast.classList.add("bg-success");
                    toast.classList.remove("bg-danger");
                }

                // Append the toast to the container
                toastContainer.appendChild(toast);

                // Initialize the Bootstrap toast and show it
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();

                // Remove the toast after it's closed
                toast.addEventListener("hidden.bs.toast", function () {
                    toast.remove();
                });
            }

            //*************************Validation**************************
            // Function to validate first name (minimum 3 characters)
            function isValidFirstName(name) {
                return name.length >= 3;
            }

            // Function to validate phone number (must be exactly 10 digits)
            function isValidPhoneNumber(phone) {
                const phoneNumberRegex = /^\d{10}$/;
                return phoneNumberRegex.test(phone);
            }

            // Function to validate pin code (must be exactly 6 digits)
            function isValidPinCode(pinCode) {
                return pinCode.length == 6;
            }

            //***************************************************************

        </script>
</body>

</html>