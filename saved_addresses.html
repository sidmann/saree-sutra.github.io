<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Address</title>
    <!-- Add Bootstrap CSS link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Add your custom CSS styles here -->
    <style>
        /* Custom CSS styles for the user profile page */
        body {
            background-image: linear-gradient(to top, #96fbc4 0%, #f9f586 100%);
            min-height: 100vh;
            flex-direction: column;
            margin: 0;
            /* position: relative; */
        }

        #main {
            flex-grow: 1;
        }

        .container {
            background-color: #ffffff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            width: 50%;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #shown-cart {
            top: -5px;
            left: 15px;
        }

        /* Additional styles for navbar */
        .navbar {
            /* background: #fff; */
            background: linear-gradient(0deg, rgba(34, 193, 195, 1) 0%, rgba(45, 175, 253, 1) 100%);
            /* border-bottom: 1px solid #ccc; */
        }

        .navbar-brand.custom-brand {
            color: #007bff;
            font-size: 2rem;
        }

        .nav-link.custom-brand {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: bold;
            margin-right: 20px;
        }

        /* Styles for centering the modal */
        .modal-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .hidden {
            display: none;
        }

        .overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(81, 79, 79, 0.5);
            backdrop-filter: blur(3px);
            z-index: 5;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .custom-label {
            margin-bottom: 0;
            /* Adjust the margin as needed */
        }

        .custom-input {
            margin-bottom: 0;
            /* Adjust the margin as needed */
        }

        .gradient-custom {
            /* fallback for old browsers */
            background: #f6d365;

            /* Chrome 10-25, Safari 5.1-6 */
            background: -webkit-linear-gradient(to right bottom,
                    rgba(246, 211, 101, 1),
                    rgba(253, 160, 133, 1));

            /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
            background: linear-gradient(to right bottom,
                    rgba(246, 211, 101, 1),
                    rgba(253, 160, 133, 1));
        }

        /* Responsive styles for small screens */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                width: 80%;
            }

            nav ul {
                text-align: center;
            }

            nav ul li {
                display: block;
                margin-bottom: 10px;
            }
        }

        .products-container {
            overflow: scroll;
            max-width: 1000px;
        }

        @media (min-width: 576px) {
            .nav-item {
                transition: all 0.3s linear;
            }

            .nav-item:hover {
                transform: translate(-0.5px, -3px);
                scale: 1.01;
            }

            .logo {
                transition: all 0.3s linear;
            }

            .logo:hover {
                scale: 1.1;
            }
        }

        footer {
            background: linear-gradient(0deg, #36dadc 0%, #64bcf3 100%);
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay">
        <div class="d-flex justify-content-center align-items-center" style="width: 100%; height: 100%">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    <div id="main" class="hidden">
        <!-- Navigation -->
        <nav class="navbar m-2 rounded-3 mt-2 shadow-sm navbar-expand-lg bg-body-tertiary pt-0" id="header">
            <div class="container-fluid">
                <a href="index.html">
                    <img src="./images/temp.png" class="navbar-brand custom-brand logo" alt="Home" width="120px"
                        title="Home"></img>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">

                    <div class="d-flex justify-content-between w-100">
                        <div class="">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="index.html">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="products.html">Products</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="aboutus.html">About Us</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link custom-brand" href="contactus.html">Contact Us</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="adminAppbar">
                                    <a class="nav-link custom-brand active" aria-current="page">Profile</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="customerAppbar">
                                    <a class="nav-link custom-brand" href="user.html">Profile</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="agentAppbar">
                                    <a class="nav-link custom-brand active" aria-current="page">Profile</a>
                                </li>
                                <li class="nav-item d-none loggedIn" id="customerAppbar">
                                    <a class="nav-link custom-brand" href="addresses.html">Addresses</a>
                                </li>
                                <li class="nav-item">
                                    <!-- Logout button with data-toggle and data-target attributes -->
                                    <button class="nav-link custom-brand" data-bs-toggle="modal"
                                        data-bs-target="#logoutConfirmationModal">
                                        Logout
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <ul class="navbar-nav mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <a class="nav-link custom-brand position-relative" href="cart.html">
                                        <i class="fa-solid fa-cart-shopping me-0"></i>
                                        <span class="position-absolute badge rounded-pill bg-danger p-1 px-2"
                                            id="shown-cart"></span>
                                        <span class="ps-0 ms-0">Cart</span>
                                    </a>
                                </li>
                                <li class="nav-item loggedOut">
                                    <a class="nav-link custom-brand" href="signup.html">Sign Up</a>
                                </li>
                                <li class="nav-item loggedOut">
                                    <a class="nav-link custom-brand" href="login.html">Login</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <!-- Toast notifications will appear here -->
        </div>

        <div class="container products-container">
            <h2>Saved Addresses</h2>

            <!-- Display the addresses in card form -->
            <div class="row" id="addressCardContainer">
                <!-- Address cards will be dynamically added here -->
            </div>

            <!-- Edit Address Modal -->
            <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
                data-bs-backdrop="static" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <input type="hidden" id="editAddressId">
                                <div class="mb-3">
                                    <label for="editFullName" class="form-label">Full Name:</label>
                                    <input type="text" class="form-control border-primary" id="editFullName" required>
                                    <small id="nameError" class="text-danger"></small>
                                </div>
                                <div class="mb-3">
                                    <label for="editMobileNumber">Mobile Number:</label>
                                    <input type="tel" class="form-control border-primary" id="editMobileNumber"
                                        required>
                                    <small id="phoneError" class="text-danger"></small>
                                </div>
                                <div class="mb-3">
                                    <label for="editHouseBuilding">House No./Building Name:</label>
                                    <input type="text" class="form-control border-primary" id="editHouseBuilding"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="editRoadAreaColony">Road Name/Area/Colony:</label>
                                    <input type="text" class="form-control border-primary" id="editRoadAreaColony"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPinCode">Pin Code:</label>
                                    <input type="text" class="form-control border-primary" id="editPinCode" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCity">City:</label>
                                    <input type="text" class="form-control border-primary" id="editCity" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editState">State:</label>
                                    <input type="text" class="form-control border-primary" id="editState" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editAddressType">Address Type:</label>
                                    <select class="form-select border-primary" id="editAddressType" required>
                                        <option value="home">Home</option>
                                        <option value="work">Work</option>
                                    </select>
                                </div>
                                <!-- Add fields for other address details (mobile number, house/building, road/area/colony, etc.) -->
                                <!-- ... -->
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="editAddressSubmitBtn">Save
                                Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logout Confirmation Modal -->
            <div class="modal fade" id="logoutConfirmationModal" tabindex="-1"
                aria-labelledby="logoutConfirmationModalLabel" data-bs-backdrop="static" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="logoutConfirmationModalLabel">
                                Confirm Logout
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">Are you sure you want to logout?</div>
                        <div class="modal-footer">
                            <!-- Cancel button to close the modal -->
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <!-- Logout button to trigger the logout -->
                            <button type="button" class="btn btn-primary" id="confirmLogoutBtn">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive"
                aria-atomic="true" id="toast-bg">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>
        </div>
        <footer class="text-center rounded-3 py-3 m-2">
            &copy; <strong>2023 Saree Sutra. All Rights Reserved.</strong>
        </footer>
    </div>

    <!-- Add Bootstrap JS and Popper.js scripts (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

    <script type="module">
        //------------------------Firebase Config-----------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
        import { ref, uploadBytes, getDownloadURL, getStorage } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-storage.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            setDoc,
            addDoc,
            deleteDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";
        import {
            getAuth,
            signOut,
            onAuthStateChanged,
            updatePassword,
            EmailAuthProvider,
            reauthenticateWithCredential,
        } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACIWl3rw02345O2RiDnqn7j9GgHFTxruw",
            authDomain: "mysarreapp.firebaseapp.com",
            projectId: "mysarreapp",
            storageBucket: "mysarreapp.appspot.com",
            messagingSenderId: "2980423532",
            appId: "1:2980423532:web:55481de5d7f31aaca37549"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");
        var userData = null;
        var loggedIn = null;

        // Function to check if the user is logged in
        function isUserLoggedIn() {
            return !!auth.currentUser;
        }

        //***********************************event listener**************************************
        // Add an event listener to the confirmation logout button
        confirmLogoutBtn.addEventListener("click", () => {
            signOut(auth)
                .then(() => {
                    // Redirect to the login page or perform any other actions
                    console.log("User logged out successfully");
                    window.location.href = "login.html"; // Redirect to the login page
                })
                .catch((error) => {
                    console.error("Error during logout:", error);
                });
        });

        //event for phone number validation
        document.querySelector("#editMobileNumber").addEventListener("keyup", () => {
            // Validate phone number
            if (!isValidPhoneNumber(document.querySelector("#editMobileNumber").value)) {
                // Display an error message
                document.getElementById("phoneError").textContent =
                    "*Phone number must be 10 digits.";
                document.getElementById("phoneError").style.scale = "1"
                // Stop the function execution if validation fails
            } else {
                document.getElementById("phoneError").textContent = "";
            }
        });

        //event for firstName validation
        document.querySelector("#editFullName").addEventListener("keyup", () => {
            if (!isValidFirstName(document.querySelector("#editFullName").value.split(' ')[0])) {
                // Display an error message
                document.getElementById("nameError").textContent =
                    "*Name must be at least 3 characters.";
            }
            else {
                document.getElementById("nameError").textContent = ''
            }
        });

        //***************************************************************************************

        //************************cart dependency************************************************
        //update cart function cart(dependency)
        async function updateCart() {
            console.log("from update cart")
            const shownCart = document.querySelector('#shown-cart')

            if (loggedIn) {
                //get user data
                const userDoc = await getUserSnapshot(auth.currentUser.uid)
                const cartSnapshot = await getDocs(collection(userDoc.ref, 'cart'))

                if (cartSnapshot.empty) {
                    shownCart.style.display = 'none'
                    return
                }

                if (cartSnapshot.size >= 1) {
                    // console.log(cartItems)
                    shownCart.textContent = cartSnapshot.size
                    shownCart.style.display = 'block'
                }
            }
            else {
                if (!sessionStorage.getItem('cart')) {
                    shownCart.style.display = 'none'
                    return
                }
                else {
                    var cartList = JSON.parse(sessionStorage.getItem('cart'))
                    shownCart.textContent = cartList.length
                    shownCart.style.display = 'block'
                }
            }
        }

        //get user snapshot cart(dependency)
        function getUserSnapshot(uid) {
            const userRef = doc(firestore, 'users', uid)
            console.log('3')
            return new Promise((resolve, reject) => {
                resolve(getDoc(userRef))
            })
        }
        //***************************************************************************************

        //*****************************loading and role access************************************
        // Use onAuthStateChanged to control access to admin dashboard
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loggedIn = true
                onLoggedIn();
                // User is authenticated
                const docRef = doc(firestore, "users", user.uid);
                const docSnap = getDoc(docRef);
                docSnap.then((docSnapshot) => {
                    // console.log(docSnapshot)
                    if (docSnapshot.exists()) {
                        userData = docSnapshot.data();
                        roleAccess(userData.role);
                        fetchAndDisplayAddresses();
                        updateCart();
                        stopLoader();
                        // console.log(userData)
                    }
                });
            } else {
                // User is not authenticated, redirect to login page
                window.location.href = "login.html";
            }
        });

        function roleAccess(role) {
            // console.log('inside role')
            const roleMap = new Map([
                ["ADMIN", "adminAppbar"],
                ["CUSTOMER", "customerAppbar"],
                ["AGENT", "agentAppbar"],
            ]);
            const appbarList = document.querySelectorAll(`#${roleMap.get(role)}`);
            appbarList.forEach((appbar) => {
                appbar.classList.remove("d-none");
            })
        }

        //to execute upon logging in
        function onLoggedIn() {
            var navItemList = document.querySelectorAll(".loggedIn");
            navItemList.forEach((navItem) => {
                navItem.style.display = "block";
            });

            navItemList = document.querySelectorAll(".loggedOut");
            navItemList.forEach((navItem) => {
                navItem.style.display = "none";
            });
        }

        //to execute upon logging out
        function onLoggedOut() {
            var navItemList = document.querySelectorAll(".loggedOut");
            navItemList.forEach((navItem) => {
                navItem.style.display = "block";
            });

            navItemList = document.querySelectorAll(".loggedIn");
            navItemList.forEach((navItem) => {
                navItem.style.display = "none";
            });
        }

        //stop the loader show the main body
        function stopLoader() {
            document.querySelector("#overlay").classList.add("hidden");
            document.querySelector("#main").classList.remove("hidden");
        }

        //***************************************************************************************

        // Function to fetch and display user's addresses
        function fetchAndDisplayAddresses() {
            const user = auth.currentUser.uid;
            const userAddressesRef = collection(firestore, 'users', user, 'addresses');

            // Clear existing address cards
            const addressCardContainer = document.getElementById("addressCardContainer");
            addressCardContainer.innerHTML = "";

            getDocs(userAddressesRef)
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const addressData = doc.data();
                        const {
                            fullName,
                            mobileNumber,
                            houseBuilding,
                            roadAreaColony,
                            pinCode,
                            city,
                            state,
                            addressType,
                            isDefault
                        } = addressData;

                        // Create a Bootstrap card for each address
                        const card = document.createElement("div");
                        card.classList.add("col-9", "mx-auto", "mb-2");
                        card.innerHTML = `
                            <div class="card shadow">
                                <div class="card-body">
                                    <h5 class="card-title">${fullName}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${mobileNumber}</h6>
                                    <p class="card-text">${houseBuilding}, ${roadAreaColony}<br>${pinCode}, ${city}, ${state}</p>
                                    <p class="card-text">Type: ${addressType}</p>
                                    ${isDefault ?
                                `<button class="btn btn-danger delete-address me-2" data-address-id="${doc.id}" id="delete-${doc.id}">Delete</button>
                                    <button class="btn btn-secondary edit-address me-2" data-address-id="${doc.id}" id="edit-${doc.id}" data-bs-toggle="modal" data-bs-target="#editAddressModal">Edit</button>
                                    <span class="badge bg-success">Default</span>` :
                                `<button class="btn btn-danger delete-address me-2" data-address-id="${doc.id}" id="delete-${doc.id}">Delete</button>
                                    <button class="btn btn-secondary edit-address me-2" data-address-id="${doc.id}" id="edit-${doc.id}" data-bs-toggle="modal" data-bs-target="#editAddressModal">Edit</button>
                                    <button class="btn btn-primary set-default-address me-2" data-address-id="${doc.id}" id="default-${doc.id}">Set as Default</button>
                                    `}
                                </div>
                            </div>
                        `;

                        addressCardContainer.appendChild(card);

                        // Add event listeners for delete and set as default buttons
                        const deleteButton = card.querySelector(".delete-address");
                        const setDefaultButton = card.querySelector(".set-default-address");
                        const setEditButton = card.querySelector(".edit-address");

                        deleteButton.addEventListener("click", async () => {
                            console.log(1)
                            document.querySelector(`#delete-${doc.id}`).disabled = true
                            document.querySelector(`#delete-${doc.id}`).textContent = 'Deleting...'
                            console.log(2)
                            // Call a function to handle address deletion
                            if (!await deleteAddress(doc.id)) {
                                console.log(5)
                                document.querySelector(`#delete-${doc.id}`).disabled = false
                                document.querySelector(`#delete-${doc.id}`).textContent = 'Delete'
                            }
                            console.log(6)
                        });

                        if (!isDefault) {
                            setDefaultButton.addEventListener("click", () => {
                                document.querySelector(`#default-${doc.id}`).disabled = true
                                document.querySelector(`#default-${doc.id}`).textContent = 'Setting as default...'
                                // Call a function to set this address as the default
                                setDefaultAddress(doc.id);
                            });
                        }

                        setEditButton.addEventListener("click", () => {
                            // Call a function to set this address as the default
                            editAddress(doc.id);
                        });
                    });
                })
                .catch((error) => {
                    console.error("Error fetching addresses: ", error);
                });
        }

        //***********************************************************************************

        // Function to delete an address
        function deleteAddress(addressId) {
            return new Promise(async (resolve) => {
                console.log(3)
                const confirmation = confirm('Are you sure you want to delete this address?');
                console.log(confirmation)
                if (confirmation) {
                    console.log(4)
                    const user = auth.currentUser.uid;
                    const userAddressRef = doc(firestore, 'users', user, 'addresses', addressId);

                    deleteDoc(userAddressRef)
                        .then(async () => {
                            // Address deleted successfully
                            console.log("Address deleted successfully");
                            // You can refresh the address list or perform other actions hered

                            getDocs(collection(firestore, 'users', user, 'addresses')).then(async (addressSnapshot) => {
                                if (addressSnapshot.empty) {
                                    fetchAndDisplayAddresses();
                                    displayMessage('Address deleted successfully!', 'success');
                                    return
                                }

                                console.log(addressSnapshot.docs[0].id)

                                var data = addressSnapshot.docs[0].data()
                                data.isDefault = true

                                await updateDoc(doc(firestore, 'users', user, 'addresses', addressSnapshot.docs[0].id), data)


                                fetchAndDisplayAddresses();
                                displayMessage('Address deleted successfully!', 'success');
                            })
                            resolve(true)
                        })
                        .catch((error) => {
                            displayMessage('Error deleting address', 'danger');
                            console.error("Error deleting address:", error);
                            // Handle the error, display an error message, or perform other actions
                        });
                }
                else {
                    console.log(5, 'from false')
                    resolve(false)
                }

            })
        }

        // Function to set an address as default
        async function setDefaultAddress(addressId) {

            const user = auth.currentUser.uid;
            const userAddressesRef = collection(firestore, 'users', user, 'addresses');
            console.log("inside default")

            const addressesDocs = await getDocs(userAddressesRef);

            addressesDocs.forEach(async (addressDoc) => {
                if (addressDoc.id === addressId) {
                    await updateDoc(doc(userAddressesRef, addressDoc.id), { isDefault: true })
                }
                else {
                    await updateDoc(doc(userAddressesRef, addressDoc.id), { isDefault: false })
                }
            })
            displayMessage('Address set as default', 'success');
            document.querySelector(`#default-${addressId}`).disabled = false
            document.querySelector(`#default-${addressId}`).textContent = 'Set as Default'
            fetchAndDisplayAddresses();
        }

        //*****************************************************************************************

        // Function to handle edit address
        function editAddress(addressId) {
            console.log("Editing address with ID:", addressId);
            const user = auth.currentUser.uid;
            const userAddressRef = doc(firestore, 'users', user, 'addresses', addressId);

            getDoc(userAddressRef)
                .then((docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const addressData = docSnapshot.data();
                        console.log(addressData)
                        const {
                            fullName,
                            mobileNumber,
                            houseBuilding,
                            roadAreaColony,
                            pinCode,
                            city,
                            state,
                            addressType,
                        } = addressData;

                        // Fill the edit form with the existing address data
                        document.getElementById("editFullName").value = fullName;
                        document.getElementById("editMobileNumber").value = mobileNumber;
                        document.getElementById("editHouseBuilding").value = houseBuilding;
                        document.getElementById("editRoadAreaColony").value = roadAreaColony;
                        document.getElementById("editPinCode").value = pinCode;
                        document.getElementById("editCity").value = city;
                        document.getElementById("editState").value = state;
                        document.getElementById("editAddressType").value = addressType;
                        document.getElementById("editAddressId").value = addressId;
                    }
                })
                .catch((error) => {
                    displayMessage('Error fetching address for edit.', 'danger');
                    console.error("Error fetching address for edit: ", error);
                });
        }

        // // Add event listeners for edit buttons
        // const editButtons = document.querySelectorAll(".edit-address");
        // editButtons.forEach((editButton) => {
        //     editButton.addEventListener("click", () => {
        //         console.log("Edit button clicked");
        //         const addressId = editButton.getAttribute("data-address-id");
        //         editAddress(addressId);
        //     });
        // });

        // Function to handle address submission
        function submitEditedAddress() {

            document.querySelector('#editAddressSubmitBtn').disabled = true
            document.querySelector('#editAddressSubmitBtn').textContent = 'Saving...'

            const [firstName, lastName] = document.getElementById("editFullName").value.split(" ");
            const mobileNumber = document.getElementById("editMobileNumber").value;
            const houseBuilding = document.getElementById("editHouseBuilding").value;
            const roadAreaColony = document.getElementById("editRoadAreaColony").value;
            const pinCode = document.getElementById("editPinCode").value;
            const city = document.getElementById("editCity").value;
            const state = document.getElementById("editState").value;
            const addressType = document.getElementById("editAddressType").value;


            // Retrieve the edited address data from the form
            const editedAddress = {
                fullName: document.getElementById("editFullName").value,
                mobileNumber: document.getElementById("editMobileNumber").value,
                houseBuilding: document.getElementById("editHouseBuilding").value,
                roadAreaColony: document.getElementById("editRoadAreaColony").value,
                pinCode: document.getElementById("editPinCode").value,
                city: document.getElementById("editCity").value,
                state: document.getElementById("editState").value,
                addressType: document.getElementById("editAddressType").value,
            };

            // Check if any of the required fields are empty
            if (!firstName || !mobileNumber || !houseBuilding || !roadAreaColony || !pinCode || !city || !state || !addressType) {
                // Display a message to the user
                displayMessage("Please fill in all the required details.", "danger");
                document.querySelector('#editAddressSubmitBtn').disabled = false
                document.querySelector('#editAddressSubmitBtn').textContent = 'Save Changes'
                return; // Stop the function execution if any required field is empty
            }

            // Validate first name (minimum 3 characters)
            if (!isValidFirstName(firstName) || (!isValidPhoneNumber(mobileNumber)) || (!isValidPinCode(pinCode))) {
                console.log(!isValidFirstName(firstName))
                console.log((!isValidPhoneNumber(mobileNumber)))
                document.querySelector('#editAddressSubmitBtn').disabled = false
                document.querySelector('#editAddressSubmitBtn').textContent = 'Save Changes'
                displayMessage('Please check your entered values!', 'danger')
                return; // Stop the function execution if validation fails
            }

            // Save the edited address data to Firestore
            const user = auth.currentUser.uid;
            const addressId = document.getElementById("editAddressId").value;
            console.log(addressId)
            const userAddressRef = doc(firestore, 'users', user, 'addresses', addressId);

            updateDoc(userAddressRef, editedAddress)
                .then(() => {
                    displayMessage('Address updated successfully!', 'success');
                    fetchAndDisplayAddresses();

                    document.querySelector('#editAddressSubmitBtn').disabled = false
                    document.querySelector('#editAddressSubmitBtn').textContent = 'Save Changes'
                })
                .catch((error) => {
                    displayMessage('Error updating address', 'danger');
                    console.error("Error updating address:", error);

                    document.querySelector('#editAddressSubmitBtn').disabled = false
                    document.querySelector('#editAddressSubmitBtn').textContent = 'Save Changes'
                });
        }

        // Add an event listener for the submit button in the edit modal
        document.getElementById("editAddressSubmitBtn").addEventListener("click", submitEditedAddress);

        //********************************pin code api integration************************************

        // Function to fetch city and state based on pin code
        document.getElementById("editPinCode").addEventListener("input", function () {
            const pinCode = this.value;
            console.log(pinCode)
            if (pinCode.length == 6) {
                fetch(`https://india-pincode-with-latitude-and-longitude.p.rapidapi.com/api/v1/pincode/${pinCode}`, {
                    method: "GET",
                    headers: {
                        'X-RapidAPI-Host': 'india-pincode-with-latitude-and-longitude.p.rapidapi.com',
                        "X-RapidAPI-Key": "0a9d852b21mshf63ae2f46afe026p106862jsn399415a4e227",
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data[0]) {
                            document.getElementById("editCity").value = data[0].district;
                            document.getElementById("editState").value = data[0].state;
                        } else {
                            displayMessage('Pin code not found.', 'danger');
                            // alert("Pin code not found.");
                        }
                    })
                    .catch(error => {
                        displayMessage('Error fetching pin code data.', 'danger');
                        // alert("Error fetching pin code data.");
                        console.error(error);
                    });
            }
        });

        //******************************toast message****************************************

        //display message function
        function displayMessage(message, type) {
            // Get the toast container element
            const toastContainer = document.querySelector(".toast-container");

            // Create a clone of the toast template
            const toast = document.querySelector(".toast").cloneNode(true);

            // Set the success message
            toast.querySelector(".toast-body").textContent = message;

            //set text type  success/danger
            if (type === "danger") {
                toast.classList.remove("bg-success");
                toast.classList.add("bg-danger");
            } else {
                toast.classList.add("bg-success");
                toast.classList.remove("bg-danger");
            }

            // Append the toast to the container
            toastContainer.appendChild(toast);

            // Initialize the Bootstrap toast and show it
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Remove the toast after it's closed
            toast.addEventListener("hidden.bs.toast", function () {
                toast.remove();
            });
        }

        //*************************Validation**************************
        // Function to validate first name (minimum 3 characters)
        function isValidFirstName(name) {
            return name.length >= 3;
        }

        // Function to validate phone number (must be exactly 10 digits)
        function isValidPhoneNumber(phone) {
            const phoneNumberRegex = /^\d{10}$/;
            return phoneNumberRegex.test(phone);
        }

        // Function to validate pin code (must be exactly 6 digits)
        function isValidPinCode(pinCode) {
            return pinCode.length == 6;
        }

        //***************************************************************

    </script>
</body>

</html>